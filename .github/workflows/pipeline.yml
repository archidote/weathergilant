name: CI/CD - code analysis and if it's ok auto deploy 
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
jobs:
  deploy:
    needs: sonarcloud 
    runs-on: ubuntu-latest 
    steps : 
      - name : Install private SSH Key 
        uses : shimataro/ssh-key-action@v2 
        with : 
          key : ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts : ${{ secrets.SSH_KNOW_HOST }}
          config : ${{ secrets.CONFIG }}
          if_key_exists: fail 
      - name : Pull
        run : | 
          ssh user@x.x.x.x '/usr/bin/nohup /usr/bin/kill -9 $(/usr/bin/pgrep -f index.py) > /dev/null 2>&1 &'
          ssh user@x.x.x.x '
          cd /home/user/weathergilannt
          /usr/bin/git pull origin main 
          /usr/bin/nohup /usr/bin/python3 /home/user/weathergilannt/index.py > /dev/null 2>&1 &'